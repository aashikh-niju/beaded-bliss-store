<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Panel | Beaded Bliss</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .admin-container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: var(--space-xl);
      background: var(--background-primary);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
    }

    .admin-header {
      text-align: center;
      margin-bottom: var(--space-2xl);
      padding-bottom: var(--space-lg);
      border-bottom: 2px solid var(--background-accent);
    }

    .admin-header h1 {
      color: var(--primary-color);
      font-size: 2.5rem;
      margin-bottom: var(--space-sm);
    }

    .admin-header p {
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--space-lg);
      margin-bottom: var(--space-2xl);
    }

    .stat-card {
      background: var(--background-secondary);
      padding: var(--space-lg);
      border-radius: var(--radius-lg);
      text-align: center;
      border: 1px solid var(--background-accent);
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: var(--space-sm);
    }

    .stat-label {
      color: var(--text-secondary);
      font-weight: 500;
    }

    .filters {
      display: flex;
      gap: var(--space-md);
      margin-bottom: var(--space-xl);
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .filter-group label {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .filter-control {
      padding: var(--space-sm) var(--space-md);
      border: 2px solid var(--background-accent);
      border-radius: var(--radius-md);
      font-size: 1rem;
      transition: var(--transition-fast);
    }

    .filter-control:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .reviews-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: var(--space-lg);
      background: var(--background-primary);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-md);
    }

    .reviews-table th,
    .reviews-table td {
      padding: var(--space-md);
      text-align: left;
      border-bottom: 1px solid var(--background-accent);
    }

    .reviews-table th {
      background: var(--primary-color);
      color: white;
      font-weight: 600;
    }

    .reviews-table tr:hover {
      background: var(--background-secondary);
    }

    .review-photo-thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .review-photo-thumb:hover {
      transform: scale(1.1);
    }

    .rating-stars {
      display: flex;
      gap: 2px;
    }

    .rating-stars .star {
      color: var(--secondary-color);
      font-size: 0.9rem;
    }

    .delete-btn {
      background: var(--error);
      color: white;
      border: none;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 0.9rem;
      transition: var(--transition-fast);
    }

    .delete-btn:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }

    .delete-btn:disabled {
      background: var(--text-light);
      cursor: not-allowed;
      transform: none;
    }

    .no-reviews {
      text-align: center;
      padding: var(--space-2xl);
      color: var(--text-light);
      font-style: italic;
    }

    .loading {
      text-align: center;
      padding: var(--space-2xl);
      color: var(--text-secondary);
    }

    .error {
      text-align: center;
      padding: var(--space-2xl);
      color: var(--error);
      background: #fef2f2;
      border-radius: var(--radius-lg);
      margin: var(--space-lg) 0;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid var(--background-accent);
      margin-bottom: var(--space-xl);
    }

    .tab-button {
      padding: var(--space-md) var(--space-xl);
      cursor: pointer;
      border: none;
      background: none;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-secondary);
      transition: var(--transition-fast);
      border-bottom: 3px solid transparent;
    }

    .tab-button.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .order-details-btn {
        background: var(--primary-light);
        color: white;
        border: none;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: 0.9rem;
        transition: var(--transition-fast);
    }
    .order-details-btn:hover {
        background: var(--primary-dark);
    }

    .stock-toggle {
        background: var(--success);
        color: white;
        border: none;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: 0.9rem;
        transition: var(--transition-fast);
    }
    .stock-toggle.out-of-stock {
        background: var(--error);
    }
    .stock-toggle:hover {
        transform: translateY(-1px);
    }

    .product-image-thumb {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: var(--radius-sm);
    }

    .stock-status {
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    .stock-status.in-stock {
        background: #dcfce7;
        color: #166534;
    }
    .stock-status.out-of-stock {
        background: #fef2f2;
        color: #dc2626;
    }
    .stock-status.low-stock {
        background: #fef3c7;
        color: #92400e;
    }

    .quantity-edit {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .quantity-input {
        width: 60px;
        padding: var(--space-xs) var(--space-sm);
        border: 2px solid var(--background-accent);
        border-radius: var(--radius-sm);
        text-align: center;
        font-size: 0.9rem;
        transition: var(--transition-fast);
    }

    .quantity-input:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .save-quantity-btn {
        background: var(--success);
        color: white;
        border: none;
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 0.8rem;
        transition: var(--transition-fast);
    }

    .save-quantity-btn:hover {
        background: #059669;
        transform: translateY(-1px);
    }

    .save-quantity-btn:disabled {
        background: var(--text-light);
        cursor: not-allowed;
        transform: none;
    }

    .price-edit {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .price-input {
        width: 80px;
        padding: var(--space-xs) var(--space-sm);
        border: 2px solid var(--background-accent);
        border-radius: var(--radius-sm);
        text-align: center;
        font-size: 0.9rem;
        transition: var(--transition-fast);
    }

    .price-input:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .save-price-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 0.8rem;
        transition: var(--transition-fast);
    }

    .save-price-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    .save-price-btn:disabled {
        background: var(--text-light);
        cursor: not-allowed;
        transform: none;
    }
    
    @media (max-width: 768px) {
      .admin-container {
        margin: 1rem;
        padding: var(--space-lg);
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .filters {
        flex-direction: column;
        align-items: stretch;
      }

      .reviews-table {
        font-size: 0.9rem;
      }

      .reviews-table th,
      .reviews-table td {
        padding: var(--space-sm);
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>‚ú® Beaded Bliss ‚ú®</h1>
    <p>Handcrafted with Love, Worn with Pride</p>
  </header>

  <nav>
    <div class="nav-links">
      <a href="index.html">üè† Home</a>
      <a href="bracelets.html">üí´ Wrist Whimsy</a>
      <a href="crochet.html">üëú Knot & Carry</a>
      <a href="clay.html">üé® ClayClicks</a>
      <a href="contact.html">üìû Contact</a>
    </div>
    <a href="cart.html" class="cart-icon">
      <img src="/photos/car.png" alt="Cart">
      <span class="cart-count" id="cart-count">0</span>
    </a>
  </nav>

  <div class="admin-container">
    <div class="admin-header">
      <h1>üîß Admin Panel</h1>
      <p>Manage customer reviews, orders, and product inventory</p>
      <div style="margin-top: 15px;">
        <a href="reset-stock.html" style="background: #dc2626; color: white; padding: 8px 16px; border-radius: 5px; text-decoration: none; font-size: 14px;">üîÑ Reset Stock Data</a>
        <span style="margin-left: 10px; font-size: 12px; color: #666;">Use this if new products aren't showing up</span>
      </div>
    </div>

    <!-- Statistics -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="total-reviews">0</div>
        <div class="stat-label">Total Reviews</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="total-orders">0</div>
        <div class="stat-label">Total Orders</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="total-products">0</div>
        <div class="stat-label">Total Products</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="out-of-stock-count">0</div>
        <div class="stat-label">Out of Stock</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avg-rating">0.0</div>
        <div class="stat-label">Average Rating</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-button active" onclick="openTab(event, 'reviews')">Reviews</button>
        <button class="tab-button" onclick="openTab(event, 'orders')">Orders</button>
        <button class="tab-button" onclick="openTab(event, 'products')">Products</button>
    </div>

    <!-- Reviews Tab -->
    <div id="reviews" class="tab-content active">
        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label for="product-filter">Filter by Product:</label>
                <select id="product-filter" class="filter-control">
                    <option value="">All Products</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="rating-filter">Filter by Rating:</label>
                <select id="rating-filter" class="filter-control">
                    <option value="">All Ratings</option>
                    <option value="5">5 Stars</option>
                    <option value="4">4+ Stars</option>
                    <option value="3">3+ Stars</option>
                    <option value="2">2+ Stars</option>
                    <option value="1">1+ Stars</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="date-filter">Sort by Date:</label>
                <select id="date-filter" class="filter-control">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                </select>
            </div>
        </div>

        <!-- Reviews Table -->
        <div id="reviews-content">
            <div class="loading">Loading reviews...</div>
        </div>
    </div>

    <!-- Orders Tab -->
    <div id="orders" class="tab-content">
        <table class="reviews-table">
            <thead>
                <tr>
                    <th>Payment ID</th>
                    <th>Customer Name</th>
                    <th>Date</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="orders-table-body">
                <!-- Orders will be dynamically inserted here -->
            </tbody>
        </table>
        <div id="no-orders" class="no-reviews" style="display: none;">No orders found.</div>
        <div id="orders-error" class="error" style="display: none;"></div>
    </div>

    <!-- Products Tab -->
    <div id="products" class="tab-content">
        <div id="products-content">
            <div class="loading">Loading products...</div>
        </div>
    </div>
  </div>

  <!-- Photo Modal -->
  <div class="photo-modal" id="photo-modal">
    <span class="close-modal" onclick="closeModal()">&times;</span>
    <div class="modal-content">
      <img id="modal-image" src="" alt="Review Photo">
    </div>
  </div>

  <footer>
    <p>&copy; 2025 Beaded Bliss | Handcrafted with ‚ù§Ô∏è </p>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>

  <script>
    // Your Firebase configuration (same as in payment.html)
    const firebaseConfig = {
      apiKey: "AIzaSyAgHThw0E2q9iHTAwvRtV5ng0TpuXn5pT0",
      authDomain: "handmadestorepayments-a815b.firebaseapp.com",
      projectId: "handmadestorepayments-a815b",
      storageBucket: "handmadestorepayments-a815b.appspot.com",
      messagingSenderId: "415509892322",
      appId: "1:415509892322:web:b23f2569a96ec27e2362bb"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    let allReviews = [];
    let allOrders = [];
    let allProducts = [];

    document.addEventListener('DOMContentLoaded', () => {
      const cartCount = document.getElementById('cart-count');
      const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
      const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
      cartCount.textContent = totalItems;
      
      loadAllReviews();
      loadAllOrders();
      loadAllProducts();
    });

    function openTab(evt, tabName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    async function loadAllProducts() {
        try {
            const savedStockData = localStorage.getItem('productStockData');
            
            // This is the complete, master list of all products
            let defaultProducts = [
                // Bracelets Category
                { id: 'ocean-bloom', name: 'Ocean Bloom', category: 'Bracelets', price: 50, image: '/photos/flower.jpg', inStock: true, stockQuantity: 5 },
                { id: 'sunset-pearl', name: 'Sunset Pearl', category: 'Bracelets', price: 50, image: '/photos/orange.png', inStock: true, stockQuantity: 3 },
                { id: 'moonlight-charm', name: 'Moonlight Charm', category: 'Bracelets', price: 50, image: '/photos/star.png', inStock: true, stockQuantity: 4 },
                { id: 'floral-grace', name: 'Floral Grace', category: 'Bracelets', price: 50, image: '/photos/jasmine.png', inStock: false, stockQuantity: 0 },
                { id: 'midnight-shine', name: 'Midnight Shine', category: 'Bracelets', price: 50, image: '/photos/black1.jpg', inStock: true, stockQuantity: 2 },
                { id: 'azure-dream', name: 'Azure Dream', category: 'Bracelets', price: 50, image: '/photos/blue.png', inStock: true, stockQuantity: 6 },
                { id: 'twilight-drops', name: 'Twilight Drops', category: 'Bracelets', price: 50, image: '/photos/stars.png', inStock: true, stockQuantity: 3 },
                { id: 'lime-bloom', name: 'Lime Bloom', category: 'Bracelets', price: 50, image: '/photos/Bloom.png', inStock: true, stockQuantity: 4 },
                // New Bracelet Products
                { id: 'blush-wings', name: 'Blush Wings', category: 'Bracelets', price: 50, image: '/photos/flies.png', inStock: true, stockQuantity: 5 },
                { id: 'heart-bloom', name: 'Heart Bloom', category: 'Bracelets', price: 50, image: '/photos/fly.png', inStock: true, stockQuantity: 4 },
                { id: 'dots-edition', name: 'DOTS Edition', category: 'Bracelets', price: 50, image: '/photos/dots.png', inStock: true, stockQuantity: 3 },
                { id: 'queen-edition', name: 'QUEEN Edition', category: 'Bracelets', price: 50, image: '/photos/dots.png', inStock: true, stockQuantity: 2 },
                // Crochet Category (Knot & Carry)
                { id: 'olive-bloom', name: 'Olive Bloom', category: 'Crochet', price: 499, image: '/photos/green bag.png', inStock: true, stockQuantity: 3 },
                { id: 'cherry-ember', name: 'Cherry Ember', category: 'Crochet', price: 499, image: '/photos/red bag.png', inStock: true, stockQuantity: 2 },
                // Clay Category (ClayClicks)
                { id: 'avobuds', name: 'AvoBuds', category: 'Clay', price: 349, image: '/photos/avacado.webp', inStock: true, stockQuantity: 4 }
            ];

            if (savedStockData) {
                let savedProducts = JSON.parse(savedStockData);
                // Create a map for quick lookups of saved products
                const savedProductsMap = new Map(savedProducts.map(p => [p.id, p]));
                
                // Merge the default list with the saved list
                // This adds new products without overwriting existing user changes
                allProducts = defaultProducts.map(defaultProduct => 
                    savedProductsMap.has(defaultProduct.id) 
                        ? savedProductsMap.get(defaultProduct.id) // Use saved data if it exists
                        : defaultProduct // Otherwise, use the new default product
                );

            } else {
                // If no saved data, use the default list
                allProducts = defaultProducts;
            }
            
            // Save the potentially merged and updated list back to localStorage
            localStorage.setItem('productStockData', JSON.stringify(allProducts));

            displayProducts();
            updateStatistics();
            
        } catch (error) {
            console.error('Error loading products:', error);
            document.getElementById('products-content').innerHTML = 
              `<div class="error"><strong>Failed to load products.</strong><br>Please check the browser console for details.<br><small>Error: ${error.message}</small></div>`;
        }
    }

    function displayProducts() {
        const productsContent = document.getElementById('products-content');
        
        if (allProducts.length === 0) {
            productsContent.innerHTML = '<div class="no-reviews">No products found.</div>';
            return;
        }
        
        productsContent.innerHTML = `
            <table class="reviews-table">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Product Name</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Stock Status</th>
                        <th>Stock Quantity</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${allProducts.map(product => `
                        <tr>
                            <td>
                                <img src="${product.image}" alt="${product.name}" class="product-image-thumb" 
                                     onerror="this.src='/photos/placeholder.jpg'">
                            </td>
                            <td><strong>${product.name}</strong></td>
                            <td>${product.category}</td>
                            <td>
                                <div class="price-edit">
                                    <input type="number" 
                                           class="price-input" 
                                           value="${product.price}" 
                                           min="0" 
                                           max="9999"
                                           onchange="updatePriceInput('${product.id}', this.value)">
                                    <button class="save-price-btn" 
                                            onclick="savePrice('${product.id}')"
                                            id="save-price-btn-${product.id}">
                                        Save
                                    </button>
                                </div>
                            </td>
                            <td>
                                <span class="stock-status ${product.inStock ? 'in-stock' : 'out-of-stock'}">
                                    ${product.inStock ? 'In Stock' : 'Out of Stock'}
                                </span>
                            </td>
                            <td>
                                <div class="quantity-edit">
                                    <input type="number" 
                                           class="quantity-input" 
                                           value="${product.stockQuantity}" 
                                           min="0" 
                                           max="999"
                                           onchange="updateQuantityInput('${product.id}', this.value)">
                                    <button class="save-quantity-btn" 
                                            onclick="saveQuantity('${product.id}')"
                                            id="save-btn-${product.id}">
                                        Save
                                    </button>
                                </div>
                            </td>
                            <td>
                                <button class="stock-toggle ${!product.inStock ? 'out-of-stock' : ''}" 
                                        onclick="toggleStockStatus('${product.id}')">
                                    ${product.inStock ? 'Mark Out of Stock' : 'Mark In Stock'}
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    function toggleStockStatus(productId) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) return;

        product.inStock = !product.inStock;
        if (!product.inStock) {
            product.stockQuantity = 0;
        } else if (product.stockQuantity === 0) {
            product.stockQuantity = 1; // Default quantity when marking back in stock
        }

        // Save updated stock data to localStorage
        localStorage.setItem('productStockData', JSON.stringify(allProducts));

        // Update the display
        displayProducts();
        updateStatistics();

        // In a real implementation, you'd save this to Firestore
        console.log(`Updated stock status for ${product.name}: ${product.inStock ? 'In Stock' : 'Out of Stock'}`);
        
        // Show success message
        alert(`Stock status updated for ${product.name}`);
    }

    function updateQuantityInput(productId, newQuantity) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) return;

        const quantity = parseInt(newQuantity) || 0;
        if (quantity < 0) return;

        // Update the product's stock quantity
        product.stockQuantity = quantity;
        
        // Update stock status based on quantity
        product.inStock = quantity > 0;
        
        // Enable save button
        const saveBtn = document.getElementById(`save-btn-${productId}`);
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save';
        }
    }

    function saveQuantity(productId) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) return;

        const saveBtn = document.getElementById(`save-btn-${productId}`);
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
        }

        localStorage.setItem('productStockData', JSON.stringify(allProducts));
        displayProducts();
        updateStatistics();

        setTimeout(() => {
            alert(`Quantity updated for ${product.name}: ${product.stockQuantity} in stock`);
        }, 100);
    }

    function updatePriceInput(productId, newPrice) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) return;

        const price = parseInt(newPrice) || 0;
        if (price < 0) return;

        // Update the product's price
        product.price = price;
        
        // Enable save button
        const saveBtn = document.getElementById(`save-price-btn-${productId}`);
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save';
        }
    }

    function savePrice(productId) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) return;

        const saveBtn = document.getElementById(`save-price-btn-${productId}`);
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
        }

        localStorage.setItem('productStockData', JSON.stringify(allProducts));
        displayProducts();
        updateStatistics();

        setTimeout(() => {
            alert(`Price updated for ${product.name}: ‚Çπ${product.price}`);
        }, 100);
    }

    async function loadAllOrders() {
        const ordersContent = document.getElementById('orders');
        const errorContainer = document.getElementById('orders-error');
        try {
            const ordersRef = db.collection('orders');
            const snapshot = await ordersRef.orderBy('createdAt', 'desc').get();
            
            allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            renderOrders(allOrders);
            updateStatistics();
            
        } catch (error) {
            console.error('Error loading orders:', error);
            const errorMessage = `
                <strong>Failed to load orders.</strong><br>
                This usually happens because a database index is required. Please check the browser's developer console (F12).
                If you see an error message with a link, please click that link to create the necessary index in Firebase.
                <br><br>
                <small><strong>Error Details:</strong> ${error.message}</small>
            `;
            errorContainer.innerHTML = errorMessage;
            errorContainer.style.display = 'block';
        }
    }

    function updateStatistics() {
      const totalReviews = allReviews.length;
      const products = [...new Set(allReviews.map(review => review.productName))];
      const totalProducts = products.length;
      
      let totalRating = 0;
      let recentReviews = 0;
      const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
      
      allReviews.forEach(review => {
        totalRating += review.rating;
        
        if (review.date && review.date.toDate() > oneWeekAgo) {
          recentReviews++;
        }
      });
      
      const averageRating = totalReviews > 0 ? (totalRating / totalReviews).toFixed(1) : '0.0';
      
      // Product statistics
      const totalProductCount = allProducts.length;
      const outOfStockCount = allProducts.filter(product => !product.inStock).length;
      
      document.getElementById('total-reviews').textContent = totalReviews;
      document.getElementById('total-products').textContent = totalProductCount;
      document.getElementById('avg-rating').textContent = averageRating;
      document.getElementById('total-orders').textContent = allOrders.length;
      document.getElementById('out-of-stock-count').textContent = outOfStockCount;
    }
    
    function showOrderDetails(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) return;

        const detailsHtml = `
            <h2>Order Details</h2>
            <p><strong>Order ID:</strong> ${order.id}</p>
            <p><strong>Payment ID:</strong> ${order.customer.paymentId}</p>
            <hr>
            <h3>Customer</h3>
            <p><strong>Name:</strong> ${order.customer.name}</p>
            <p><strong>Email:</strong> ${order.customer.email}</p>
            <p><strong>Phone:</strong> ${order.customer.phone}</p>
            <p><strong>Address:</strong> ${order.customer.address.street}, ${order.customer.address.city}, ${order.customer.address.state} - ${order.customer.address.zip}</p>
            <hr>
            <h3>Items</h3>
            <ul>${order.items.map(item => `<li>${item}</li>`).join('')}</ul>
            <hr>
            <h3>Total: ‚Çπ${order.amount.toFixed(2)}</h3>
        `;
        
        // Using a simple alert for now, can be replaced with a modal
        alert(detailsHtml.replace(/<br>|<h2>|<h3>|<h4>|<h5>|<h6>|<p>|<li>|<\/li>|<\/p>|<\/h2>|<\/h3>|<\/h4>|<\/h5>|<\/h6>|<ul>|<\/ul>|<hr>/g, "\n").replace(/<strong>|<\/strong>/g, ""));
    }

    async function loadAllReviews() {
      try {
        const reviewsRef = db.collection('reviews');
        const snapshot = await reviewsRef.orderBy('date', 'desc').get();
        
        allReviews = [];
        snapshot.forEach(doc => {
          allReviews.push({ id: doc.id, ...doc.data() });
        });
        
        updateStatistics();
        populateProductFilter();
        displayReviews();
        
      } catch (error) {
        console.error('Error loading reviews:', error);
        document.getElementById('reviews-content').innerHTML = 
          `<div class="error">
              <strong>Failed to load reviews.</strong><br>
              Please check your Firebase connection and the browser console for details.
              <br><small>Error: ${error.message}</small>
           </div>`;
      }
    }

    function populateProductFilter() {
      const productFilter = document.getElementById('product-filter');
      const products = [...new Set(allReviews.map(review => review.productName))];
      
      // Clear existing options except "All Products"
      productFilter.innerHTML = '<option value="">All Products</option>';
      
      products.forEach(product => {
        const option = document.createElement('option');
        option.value = product;
        option.textContent = product;
        productFilter.appendChild(option);
      });
    }

    function displayReviews() {
      const productFilter = document.getElementById('product-filter').value;
      const ratingFilter = document.getElementById('rating-filter').value;
      const dateFilter = document.getElementById('date-filter').value;
      
      let filteredReviews = [...allReviews];
      
      // Apply product filter
      if (productFilter) {
        filteredReviews = filteredReviews.filter(review => review.productName === productFilter);
      }
      
      // Apply rating filter
      if (ratingFilter) {
        const minRating = parseInt(ratingFilter);
        filteredReviews = filteredReviews.filter(review => review.rating >= minRating);
      }
      
      // Apply date filter
      filteredReviews.sort((a, b) => {
        const dateA = a.date ? a.date.toDate() : new Date(0);
        const dateB = b.date ? b.date.toDate() : new Date(0);
        return dateFilter === 'oldest' ? dateA - dateB : dateB - dateA;
      });
      
      const reviewsContent = document.getElementById('reviews-content');
      
      if (filteredReviews.length === 0) {
        reviewsContent.innerHTML = '<div class="no-reviews">No reviews found matching the selected filters.</div>';
        return;
      }
      
      reviewsContent.innerHTML = `
        <table class="reviews-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Reviewer</th>
              <th>Rating</th>
              <th>Review</th>
              <th>Photo</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filteredReviews.map(review => `
              <tr>
                <td><strong>${review.productName}</strong></td>
                <td>${review.reviewerName}</td>
                <td>
                  <div class="rating-stars">
                    ${'‚òÖ'.repeat(review.rating)}${'‚òÜ'.repeat(5 - review.rating)}
                  </div>
                </td>
                <td>${review.reviewText}</td>
                <td>
                  ${review.photoUrl ? 
                    `<img src="${review.photoUrl}" alt="Review Photo" class="review-photo-thumb" onclick="openModal('${review.photoUrl}')">` : 
                    'No photo'
                  }
                </td>
                <td>${review.date ? new Date(review.date.toDate()).toLocaleDateString() : 'N/A'}</td>
                <td>
                  <button class="delete-btn" onclick="deleteReview('${review.id}', '${review.photoUrl}')">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function deleteReview(reviewId, photoUrl) {
      if (!confirm('Are you sure you want to delete this review?')) {
        return;
      }
      
      const deleteBtn = event.target;
      deleteBtn.disabled = true;
      deleteBtn.textContent = 'Deleting...';
      
      try {
        // Delete photo from Firebase Storage if it exists
        if (photoUrl) {
          try {
            const photoRef = storage.refFromURL(photoUrl);
            await photoRef.delete();
          } catch (error) {
            console.error('Error deleting photo:', error);
            // Continue with review deletion even if photo deletion fails
          }
        }
        
        // Delete review from Firestore
        await db.collection('reviews').doc(reviewId).delete();
        
        // Reload reviews
        await loadAllReviews();
        alert('Review deleted successfully');
        
      } catch (error) {
        console.error('Error deleting review:', error);
        alert('Failed to delete review. Please try again.');
        deleteBtn.disabled = false;
        deleteBtn.textContent = 'Delete';
      }
    }

    function openModal(photoSrc) {
      document.getElementById('modal-image').src = photoSrc;
      document.getElementById('photo-modal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('photo-modal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('photo-modal');
      if (event.target === modal) {
        closeModal();
      }
    }

    // Event listeners for filters
    document.getElementById('product-filter').addEventListener('change', displayReviews);
    document.getElementById('rating-filter').addEventListener('change', displayReviews);
    document.getElementById('date-filter').addEventListener('change', displayReviews);

    function renderOrders(orders) {
        const ordersTableBody = document.getElementById('orders-table-body');
        const noOrdersMessage = document.getElementById('no-orders');
        
        if (!ordersTableBody || !noOrdersMessage) return;

        if (orders.length === 0) {
            ordersTableBody.innerHTML = '';
            noOrdersMessage.style.display = 'block';
            return;
        }

        noOrdersMessage.style.display = 'none';
        
        // Sort orders by date, newest first
        const sortedOrders = orders.sort((a, b) => {
            const dateA = a.createdAt ? a.createdAt.toDate() : 0;
            const dateB = b.createdAt ? b.createdAt.toDate() : 0;
            return dateB - dateA;
        });

        ordersTableBody.innerHTML = sortedOrders.map(order => {
            const customerName = order.customer && order.customer.name ? order.customer.name : 'N/A';
            const orderDate = order.createdAt ? new Date(order.createdAt.toDate()).toLocaleString() : 'N/A';
            
            // Handle both 'amount' and 'totalAmount' for backward compatibility
            const totalAmount = typeof order.totalAmount === 'number' 
                ? `‚Çπ${order.totalAmount.toFixed(2)}` 
                : (typeof order.amount === 'number' ? `‚Çπ${order.amount.toFixed(2)}` : 'N/A');

            const status = order.status || 'Pending';
            
            // Handle both new (array of objects) and old (array of strings) item structures
            const itemsSummary = Array.isArray(order.items)
                ? order.items.map(item => {
                    if (typeof item === 'object' && item.name) {
                        return `${item.name} (x${item.quantity || 1})`;
                    }
                    return item; // For old string-based items
                }).join(',<br>')
                : 'Items not available';

            return `
                <tr>
                    <td>${order.paymentId || 'N/A'}</td>
                    <td>${customerName}</td>
                    <td>${orderDate}</td>
                    <td>${itemsSummary}</td>
                    <td>${totalAmount}</td>
                    <td><span class="status-${status.toLowerCase()}">${status}</span></td>
                </tr>
            `;
        }).join('');
    }
  </script>
</body>
</html> 